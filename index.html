<!DOCTYPE html>
<html>
    <head>
        <title>Backspace Bowling</title>
    </head>
    <body>
        <button id="start" type="button" onClick="startBowling()">Start New Game</button>
        <div align="center">
            <input type="text" id="bowling" style="width:600px;" onkeydown="keyDown(event)" onkeyup="keyUp(event)" autofocus>
        </div>
        <table id="scoretable" border="1" cellpadding="1" cellspacing="1">
            <tbody>
                <tr>
                    <td>Frame</td>
                    <td>Score</td>
                </tr>
                <tr>
                    <td>1</td>
                    <td id="f1">&nbsp;</td>
                </tr>
                <tr>
                    <td>2</td>
                    <td id="f2">&nbsp;</td>
                </tr>
                <tr>
                    <td>3</td>
                    <td id="f3">&nbsp;</td>
                </tr>
                <tr>
                    <td>4</td>
                    <td id="f4">&nbsp;</td>
                </tr>
                <tr>
                    <td>5</td>
                    <td id="f5">&nbsp;</td>
                </tr>
                <tr>
                    <td>6</td>
                    <td id="f6">&nbsp;</td>
                </tr>
                <tr>
                    <td>7</td>
                    <td id="f7">&nbsp;</td>
                </tr>
                <tr>
                    <td>8</td>
                    <td id="f8">&nbsp;</td>
                </tr>
                <tr>
                    <td>9</td>
                    <td id="f9">&nbsp;</td>
                </tr>
                <tr>
                    <td>10</td>
                    <td id="f10">&nbsp;</td>
                </tr>
                <tr>
                    <td><b>Total</b></td>
                    <td id="total">&nbsp;</td>
                </tr>
            </tbody>
        </table>

        <footer align="center">
            Backspace Bowling by
            <a href="https://www.tannerkrewson.com/" target="_blank">
                Tanner Krewson
            </a>
            <br />
            <a href="https://github.com/tannerkrewson/backspace-bowling" target="_blank">
                View on GitHub
            </a>
        </footer>

        <script>
            const leadingZeroes = 5;
            const pins = "135797531";
            const trailingZeroes = 56;
            const totalNumberOfFrames = 10;

            const laneBox = document.getElementById('bowling');
            const scoreTable = document.getElementById('scoretable');

            var blockInput;
            var rolling = false;
            var frame;
            var totalScore;
            var gameInProgress = false;

            setLaneBoxReadOnly(true);

            function startBowling() {
                refillBox();
                clearScoreTable();
                frame = 1;
                totalScore = 0;
                gameInProgress = true;
                setLaneBoxReadOnly(false);
                focusBox();
            }

            function keyDown(event) {
                if (blockInput || event.keyCode !== 8) {
                    if (gameInProgress) {
                        refillBox();
                    } else {
                        clearBox();
                    }
                    return;
                }
                rolling = true;
            }

            function keyUp(event) {
                if (blockInput || !rolling || event.keyCode !== 8) {
                    if (gameInProgress) {
                        refillBox();
                    } else {
                        clearBox();
                    }
                    return;
                }
                var result = laneBox.value;
                score(result);
                if (gameInProgress) {
                    advanceFrame();
                    refillBox();
                    focusBox();
                    rolling = false;
                }
            }

            function setLaneBoxReadOnly(tf) {
                blockInput = tf;
                laneBox.readOnly = tf;
            }

            function refillBox() {
                laneBox.value = getLaneString();
                console.log('yo!');
            }

            function clearBox() {
                laneBox.value = '';
                console.log('hey');
            }

            function focusBox() {
                laneBox.focus();
            }

            function getLaneString() {
                var lane = '';

                lane = addZeroesToString(lane, leadingZeroes);
                lane = lane + pins;
                lane = addZeroesToString(lane, trailingZeroes);

                return lane;

                function addZeroesToString(str, numOfZeroes) {
                    for (i = 0; i < numOfZeroes; i++) {
                        str = str + '0';
                    }
                    return str;
                }
            }

            function score(lane) {
                var score = getScore(lane);
                addToTotal(score);
                writeTotal(totalScore);
                scoreTable.rows[frame].cells[1].firstChild.data = score;
                alert('You\'ve scored ' + score);
                if (frame >= totalNumberOfFrames) {
                    endGame();
                }
            }

            function addToTotal(n){
                totalScore += n;
            }

            function writeTotal(total){
                scoreTable.rows[totalNumberOfFrames+1].cells[1].firstChild.data = total;
            }

            function advanceFrame() {
                frame++;
            }

            function getScore(lane) {
                return parseInt(lane.slice(-1));
            }

            function endGame() {
                gameInProgress = false;
                setLaneBoxReadOnly(true);
                alert('Total score: ' + totalScore);
                clearBox();
            }

            function clearScoreTable() {
                for (var i = 1; i <= totalNumberOfFrames + 1; i++) {
                    scoreTable.rows[i].cells[1].firstChild.data = '';
                }
            }

        </script>
    </body>
</html>
